---
/**
 * KnowledgeColumn Component
 * Column 2: "Faglig viden"
 * Contains search placeholder, popular topics chips, and curated content
 */

import type { DashboardKnowledge, DashboardCategory } from '@/types/sanity'

interface Props {
  knowledge: DashboardKnowledge | null
}

const { knowledge } = Astro.props

// Category label mapping
const categoryLabels: Record<DashboardCategory, string> = {
  'drift-kampagne': 'Drift & kampagne',
  'oekonomi': '√òkonomi',
  'generelt': 'Generelt',
}

// CTA text based on content type
const getCtaText = (contentType: 'article' | 'video') => {
  return contentType === 'video' ? 'Se video' : 'L√¶s artiklen'
}

// Get link for knowledge item
const getItemLink = (item: DashboardKnowledge['items'][0]) => {
  if (item.articleRef?.slug) {
    return `/andelshavere/artikler/${item.articleRef.slug}`
  }
  return item.manualLink || '#'
}

// Get title for knowledge item
const getItemTitle = (item: DashboardKnowledge['items'][0]) => {
  return item.articleRef?.title || item.manualTitle || 'Uden titel'
}

// Default values
const searchPlaceholder = knowledge?.searchPlaceholder || 'Hvad s√∏ger du efter‚Ä¶?'
const searchLink = knowledge?.searchLink || '/andelshavere/vidensbase'
const sectionTitle = knowledge?.title || 'Aktuelt fra AKD Agro'
const popularTopics = knowledge?.popularTopics || []
const items = knowledge?.items || []
---

<div class="knowledge-column bg-light rounded-lg p-6">
  <!-- Search Invitation Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-serif font-bold text-forest-green mb-4 uppercase tracking-wide">
      Faglig viden
    </h2>
    
    <a 
      href={searchLink}
      class="search-link flex items-center gap-3 bg-white border border-charcoal/20 rounded-lg p-4 hover:border-forest-green hover:shadow-sm transition-all group"
    >
      <span class="text-2xl text-charcoal/50 group-hover:text-forest-green transition-colors" aria-hidden="true">üîç</span>
      <span class="text-charcoal/60 group-hover:text-charcoal transition-colors">{searchPlaceholder}</span>
    </a>
    
    <p class="text-sm text-charcoal/60 mt-2 mb-3">
      <a href={searchLink} class="text-burnt-orange hover:text-amber transition-colors">
        G√• til vidensbasen ‚Üí
      </a>
    </p>
    
    {popularTopics.length > 0 && (
      <div class="mt-4">
        <p class="text-sm text-charcoal/70 mb-2">Popul√¶re emner:</p>
        <div class="flex flex-wrap gap-2">
          {popularTopics.map((topic) => (
            <a 
              href={topic.link || searchLink}
              class="topic-chip inline-block px-3 py-1.5 bg-white border border-charcoal/15 rounded-full text-sm text-charcoal hover:bg-forest-green hover:text-white hover:border-forest-green transition-all"
            >
              {topic.label}
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
  
  <!-- Curated Content Section -->
  {items.length > 0 && (
    <div class="curated-section pt-6 border-t border-charcoal/10">
      <h3 class="text-[22px] font-serif font-bold text-forest-green mb-4 uppercase tracking-wide">
        {sectionTitle}
      </h3>
      
      <ul class="space-y-4" role="list">
        {items.map((item) => (
          <li class="knowledge-item flex gap-3">
            {item.contentType === 'video' && (
              <button
                type="button"
                class="video-trigger video-thumb relative w-16 h-12 flex-shrink-0 bg-charcoal/10 rounded overflow-hidden cursor-pointer"
                data-video-url={item.videoUrl || ''}
                data-video-title={item.videoTitle || getItemTitle(item)}
                aria-label={`Afspil video: ${item.videoTitle || getItemTitle(item)}`}
              >
                {item.thumbnail ? (
                  <img 
                    src={item.thumbnail} 
                    alt="" 
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center">
                    <span class="text-charcoal/40">‚ñ∂</span>
                  </div>
                )}
                <span class="absolute inset-0 flex items-center justify-center bg-black/30">
                  <span class="text-white text-sm">‚ñ∂Ô∏é</span>
                </span>
              </button>
            )}
            {item.contentType === 'article' && (
              <div class="article-icon w-8 h-8 flex-shrink-0 bg-forest-green/10 rounded flex items-center justify-center">
                <span class="text-forest-green text-sm">üìÑ</span>
              </div>
            )}
            <div class="flex-grow min-w-0">
              <h4 class="font-medium text-charcoal leading-snug mb-1 line-clamp-2">
                {getItemTitle(item)}
              </h4>
              <p class="text-xs text-charcoal/60 mb-1">
                {item.contentType === 'video' ? 'Video' : 'Artikel'}
                {item.category && ` ¬∑ ${categoryLabels[item.category]}`}
              </p>
              {item.contentType === 'video' && item.videoUrl ? (
                <button
                  type="button"
                  class="video-trigger inline-flex items-center gap-1 text-burnt-orange hover:text-amber transition-colors text-sm font-medium"
                  data-video-url={item.videoUrl}
                  data-video-title={item.videoTitle || getItemTitle(item)}
                >
                  Se video
                  <span aria-hidden="true">‚ñ∂</span>
                </button>
              ) : (
                <a 
                  href={getItemLink(item)}
                  class="inline-flex items-center gap-1 text-burnt-orange hover:text-amber transition-colors text-sm font-medium"
                >
                  {getCtaText(item.contentType)}
                  <span aria-hidden="true">‚Üí</span>
                </a>
              )}
            </div>
          </li>
        ))}
      </ul>
    </div>
  )}
</div>

<script>
  // Wire video triggers in KnowledgeColumn to open the global VideoModal
  document.querySelectorAll<HTMLElement>('.knowledge-column .video-trigger').forEach((btn) => {
    btn.addEventListener('click', () => {
      const url = btn.dataset.videoUrl;
      const title = btn.dataset.videoTitle;
      if (url && typeof (window as any).openVideoModal === 'function') {
        (window as any).openVideoModal(url, title);
      }
    });
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .knowledge-item {
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(38, 37, 30, 0.06);
  }
  
  .knowledge-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
</style>
