---
interface Props {
  theme?: 'light' | 'dark'
}

const { theme = 'light' } = Astro.props

// Check if user is logged in (server-side)
const user = Astro.locals.user
const isLoggedInServer = !!user

// Debug logging (remove in production)
if (import.meta.env.DEV) {
  console.log('[LoginButton] User check:', {
    hasUser: !!user,
    userId: user?.id,
    pathname: Astro.url.pathname
  })
}

const loginHref = isLoggedInServer ? '/andelshavere/dashboard' : '/andelshavere/login'
const loginAriaLabel = isLoggedInServer ? 'Gå til andelshaver-området' : 'Log ind til andelshaver-området'
---

<a 
  href={loginHref}
  class="login-button"
  aria-label={loginAriaLabel}
  id="login-button-link"
>
  <span class="login-text">For andelshavere</span>
  <span class="login-icon-circle" aria-hidden="true" id="login-icon-container" data-logged-in={isLoggedInServer}>
    <!-- Open lock icon -->
    <svg 
      id="open-lock-icon"
      class="w-5 h-5 text-white" 
      fill="currentColor" 
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      style={isLoggedInServer ? 'display: block;' : 'display: none;'}
    >
      <g data-name="Layer 2">
        <path d="M18 22.75H6A2.753 2.753 0 0 1 3.25 20v-8A2.753 2.753 0 0 1 6 9.25h12A2.753 2.753 0 0 1 20.75 12v8A2.753 2.753 0 0 1 18 22.75m-12-12A1.25 1.25 0 0 0 4.75 12v8A1.25 1.25 0 0 0 6 21.25h12A1.25 1.25 0 0 0 19.25 20v-8A1.25 1.25 0 0 0 18 10.75Z"/>
        <path d="M17.5 10.75h-11a.75.75 0 0 1-.75-.75V7.5a6.25 6.25 0 0 1 12.265-1.705.75.75 0 1 1-1.444.409A4.75 4.75 0 0 0 7.25 7.5v1.75H17.5a.75.75 0 0 1 0 1.5M12 16.75a.75.75 0 0 1-.75-.75v-1a.75.75 0 0 1 1.5 0v1a.75.75 0 0 1-.75.75"/>
      </g>
    </svg>
    <!-- Closed lock icon -->
    <svg 
      id="closed-lock-icon"
      class="w-5 h-5 text-white" 
      fill="currentColor" 
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      style={isLoggedInServer ? 'display: none;' : 'display: block;'}
    >
      <g data-name="Layer 2">
        <path d="M18 22.75H6A2.753 2.753 0 0 1 3.25 20v-8A2.753 2.753 0 0 1 6 9.25h12A2.753 2.753 0 0 1 20.75 12v8A2.753 2.753 0 0 1 18 22.75m-12-12A1.25 1.25 0 0 0 4.75 12v8A1.25 1.25 0 0 0 6 21.25h12A1.25 1.25 0 0 0 19.25 20v-8A1.25 1.25 0 0 0 18 10.75z"/>
        <path d="M17.5 10.75h-11a.75.75 0 0 1-.75-.75V7.5a6.25 6.25 0 0 1 12.5 0V10a.75.75 0 0 1-.75.75M7.25 9.25h9.5V7.5a4.75 4.75 0 0 0-9.5 0zM12 16.75a.75.75 0 0 1-.75-.75v-1a.75.75 0 0 1 1.5 0v1a.75.75 0 0 1-.75.75"/>
      </g>
    </svg>
  </span>
</a>

<style>
  .login-button {
    @apply inline-flex items-center gap-3
           bg-burnt-orange
           h-12 pl-6 pr-[3px] rounded-full
           focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-burnt-orange
           relative overflow-hidden;
  }
  
  /* Expanding circle background effect */
  .login-button::before {
    content: '';
    position: absolute;
    right: 3px;
    top: 50%;
    transform: translateY(-50%);
    width: 42px;
    height: 42px;
    background-color: #F5A623; /* amber */
    border-radius: 50%;
    transition: all 0.35s ease-out;
    z-index: 1;
  }
  
  .login-button:hover::before {
    width: calc(100% - 6px);
    height: calc(100% - 6px);
    border-radius: 9999px; /* Stay rounded */
  }
  
  .login-text {
    @apply text-white text-lg font-sans font-normal flex-1 relative z-10;
    transition: color 0.35s ease-out;
  }
  
  .login-button:hover .login-text {
    color: #26251E; /* charcoal */
  }
  
  .login-icon-circle {
    @apply flex items-center justify-center
           w-[42px] h-[42px] rounded-full
           flex-shrink-0 ml-auto relative z-10;
    background-color: transparent;
  }
  
  .login-icon-circle svg {
    @apply text-white;
    transition: color 0.35s ease-out;
  }
  
  .login-button:hover .login-icon-circle svg {
    color: #26251E; /* charcoal */
  }

  /* Responsive adjustments */
  @media (max-width: 1023px) {
    .login-text {
      @apply text-base;
    }
  }

  @media (max-width: 767px) {
    .login-button {
      @apply pl-4 pr-[3px] gap-2;
    }
    
    .login-text {
      @apply text-sm;
    }
    
    .login-icon-circle {
      @apply w-9 h-9;
    }
    
    .login-button::before {
      width: 36px;
      height: 36px;
    }
  }
</style>

<script>
  // Check authentication status client-side for pre-rendered pages
  // Since HTTP-only cookies can't be read via JS, we check by trying to access a protected endpoint
  async function checkAuthStatus() {
    try {
      // Try to fetch a lightweight endpoint that will return 200 if authenticated, redirect to login if not
      const response = await fetch('/andelshavere/dashboard', { 
        method: 'HEAD',
        credentials: 'include',
        redirect: 'follow' // Follow redirects
      });
      
      // Check if we ended up on the login page (redirected) or on the dashboard (authenticated)
      // response.url will be the final URL after redirects
      const isAuthenticated = response.ok && 
                              response.status === 200 && 
                              !response.url.includes('/andelshavere/login');
      
      const iconContainer = document.getElementById('login-icon-container');
      const openIcon = document.getElementById('open-lock-icon');
      const closedIcon = document.getElementById('closed-lock-icon');
      const loginLink = document.getElementById('login-button-link');
      
      if (iconContainer && openIcon && closedIcon && loginLink) {
        if (isAuthenticated) {
          // Show open lock
          openIcon.style.display = 'block';
          closedIcon.style.display = 'none';
          
          // Update link
          loginLink.href = '/andelshavere/dashboard';
          loginLink.setAttribute('aria-label', 'Gå til andelshaver-området');
        } else {
          // Show closed lock (already shown by default)
          openIcon.style.display = 'none';
          closedIcon.style.display = 'block';
          
          // Ensure link points to login
          loginLink.href = '/andelshavere/login';
          loginLink.setAttribute('aria-label', 'Log ind til andelshaver-området');
        }
      }
    } catch (error) {
      // If check fails, keep default state (closed lock)
      console.error('[LoginButton] Auth check failed:', error);
    }
  }
  
  // Run on page load (only if server-side didn't detect auth)
  if (!document.getElementById('login-icon-container')?.dataset.loggedIn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAuthStatus);
    } else {
      checkAuthStatus();
    }
  }
</script>

