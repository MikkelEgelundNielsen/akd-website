---
import MainNav from './MainNav.astro'
import SubNav from './SubNav.astro'
import { sanityClient } from '@/lib/sanity'
import { navigationQuery } from '@/lib/sanityQueries'
import type { Navigation } from '@/types/sanity'

interface Props {
  theme?: 'light' | 'dark'
}

const { theme = 'light' } = Astro.props
const currentPath = Astro.url.pathname

// Fetch navigation from Sanity
const navigation: Navigation = await sanityClient.fetch(navigationQuery)
const navigationItems = navigation?.menuItems || []

// Find current main nav item based on path
// Check both parent page and child pages
const currentMainItem = navigationItems.find(item => {
  // Special case: Don't match frontpage unless explicitly targeting it
  if (currentPath === '/' && item.href !== '/') {
    return false
  }
  
  // Check if we're on the parent page
  if (currentPath.startsWith(item.href) && item.href !== '/') {
    return true
  }
  
  // Exact match for root
  if (currentPath === '/' && item.href === '/') {
    return true
  }
  
  // Check if we're on one of the child pages
  if (item.subItems && item.subItems.length > 0) {
    return item.subItems.some(subItem => currentPath.startsWith(subItem.href) && subItem.href !== '/')
  }
  
  return false
})

const hasSubNav = currentMainItem?.subItems && currentMainItem.subItems.length > 0

// Convert subItems to the format SubNav expects
const subNavItems = currentMainItem?.subItems?.map(item => ({
  label: item.label,
  href: item.href
})) || []
---

<header 
  class={`navigation-wrapper fixed top-0 left-0 right-0 z-50 transition-shadow duration-200 ${theme === 'dark' ? 'bg-forest-green' : 'bg-warm-light'}`}
  data-theme={theme}
>
  <MainNav theme={theme} currentPath={currentPath} />
  
  {hasSubNav && (
    <SubNav 
      parentLabel={currentMainItem.label}
      items={subNavItems}
      currentPath={currentPath}
      theme={theme}
    />
  )}
</header>

<!-- Spacer to prevent content from hiding under fixed nav -->
<!-- Responsive height: smaller on mobile, larger on desktop -->
{hasSubNav ? (
  <div class="nav-spacer h-36 sm:h-40 md:h-44 lg:h-46" aria-hidden="true"></div>
) : (
  <div class="nav-spacer h-24 sm:h-26 md:h-28 lg:h-31" aria-hidden="true"></div>
)}

<script>
  // Add shadow and shrink on scroll
  const header = document.querySelector('.navigation-wrapper')
  
  if (header) {
    let lastScroll = 0
    
    const handleScroll = () => {
      const currentScroll = window.pageYOffset
      
      // Add shadow and shrink class when scrolled down
      if (currentScroll > 10) {
        header.classList.add('shadow-lg', 'scrolled')
      } else {
        header.classList.remove('shadow-lg', 'scrolled')
      }
      
      lastScroll = currentScroll
    }
    
    // Initial check
    handleScroll()
    
    // Listen to scroll events
    window.addEventListener('scroll', handleScroll, { passive: true })
  }
</script>

<style>
  .navigation-wrapper {
    transition: box-shadow 0.2s ease, height 0.3s ease;
  }
  
  /* Ensure proper z-index stacking */
  .navigation-wrapper {
    z-index: 50;
  }
  
  /* Smooth height transition when scrolled */
  .navigation-wrapper.scrolled {
    /* Additional styling can be added here if needed */
  }
</style>

