---
import BaseLayout from '@/layouts/BaseLayout.astro'
import TextPage from '@/components/templates/TextPage.astro'
import PortableText from '@/components/sanity/PortableText.astro'
import { sanityClient } from '@/lib/sanity'
import { generalPageBySlugQuery, allGeneralPagesQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { GeneralPage } from '@/types/sanity'

// Pre-render all Sanity pages at build time using getStaticPaths
export const prerender = true;

// In hybrid mode, getStaticPaths is used to generate all pages at build time
export async function getStaticPaths() {
  const pages = await sanityClient.fetch(allGeneralPagesQuery)
  
  console.log('Generated paths for pages:', pages.map((p: any) => p.slug.current).join(', '))
  
  return pages.map((page: any) => ({
    params: { slug: page.slug.current },
    props: { page }
  }))
}

// Get the page data from props or fetch it in SSR mode
let { page } = Astro.props as { page: GeneralPage }

// In SSR mode, page might not be provided, so fetch it from Sanity
if (!page) {
  const slug = Astro.params.slug
  // generalPageBySlugQuery is a function that returns a query string
  page = await sanityClient.fetch(generalPageBySlugQuery(slug || ''))
  
  if (!page) {
    // Page not found - return 404
    return Astro.redirect('/404')
  }
}

// Debug: log the page data
console.log('Page slug:', page?.slug?.current || page?.slug)
console.log('Page has content:', !!page?.content)
console.log('Content length:', page?.content?.length)
console.log('Has TOC:', !!page?.tableOfContents)
console.log('TOC length:', page?.tableOfContents?.length)

// Convert headline to HTML (with mint accent support)
const headlineHtml = page.headline ? portableTextToHtml(page.headline, { addHeadingIds: false }) : page.title

// Prepare sections for TOC
const sections = page.showTableOfContents && page.tableOfContents 
  ? page.tableOfContents.map(section => ({
      id: section.id,
      title: section.title
    }))
  : []

// Get SEO metadata
const metaTitle = page.seo?.metaTitle || `${page.title} | AKD Danmark`
const metaDescription = page.seo?.metaDescription || ''
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
>
  <TextPage
    preHeader={page.preHeader}
    headline={headlineHtml}
    sections={sections}
  >
    <PortableText 
      content={page.content} 
      addHeadingIds={true}
    />
    
    {page.updatedAt && (
      <p class="text-sm text-charcoal/70 mt-12">
        Denne side er senest opdateret: {new Date(page.updatedAt).toLocaleDateString('da-DK', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </p>
    )}
  </TextPage>
</BaseLayout>

