---
import BaseLayout from '@/layouts/BaseLayout.astro'
import TextPage from '@/components/templates/TextPage.astro'
import PortableText from '@/components/sanity/PortableText.astro'
import { sanityClient } from '@/lib/sanity'
import { generalPageBySlugQuery, allGeneralPagesQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { GeneralPage } from '@/types/sanity'

// Pre-render all Sanity pages at build time using getStaticPaths
export const prerender = true;

// In hybrid mode, getStaticPaths is used to generate all pages at build time
export async function getStaticPaths() {
  const pages = await sanityClient.fetch(allGeneralPagesQuery)
  
  // Filter out pages that start with /andelshavere/ - those are handled by /andelshavere/[...slug].astro
  // Also filter out pages with slashes (multi-segment paths) as [slug] only handles single segments
  const filteredPages = pages.filter((page: any) => {
    const slug = page.slug?.current || ''
    // Normalize slug for checking (remove leading slash)
    const normalizedSlug = slug.startsWith('/') ? slug.slice(1) : slug
    // Exclude /andelshavere/ pages and any slug with slashes (multi-segment)
    return !normalizedSlug.startsWith('andelshavere/') && !normalizedSlug.includes('/')
  })
  
  console.log('Generated paths for pages:', filteredPages.map((p: any) => p.slug.current).join(', '))
  
  return filteredPages.map((page: any) => {
    const slug = page.slug.current
    // Remove leading slash for single-segment route
    const slugParam = slug.startsWith('/') ? slug.slice(1) : slug
    
    return {
      params: { slug: slugParam },
      props: { page }
    }
  })
}

// Get the page data from props or fetch it in SSR mode
let { page } = Astro.props as { page: GeneralPage }

// In SSR mode, page might not be provided, so fetch it from Sanity
if (!page) {
  const slugParam = Astro.params.slug || ''
  // Try with and without leading slash since Sanity slugs may vary
  const slugWithSlash = slugParam.startsWith('/') ? slugParam : `/${slugParam}`
  const slugWithoutSlash = slugParam.startsWith('/') ? slugParam.slice(1) : slugParam
  
  // Try both formats
  page = await sanityClient.fetch(generalPageBySlugQuery(slugWithSlash)) ||
         await sanityClient.fetch(generalPageBySlugQuery(slugWithoutSlash))
  
  if (!page) {
    // Page not found - return 404
    return Astro.redirect('/404')
  }
}

// Debug: log the page data
console.log('Page slug:', page?.slug?.current || page?.slug)
console.log('Page has content:', !!page?.content)
console.log('Content length:', page?.content?.length)
console.log('Has TOC:', !!page?.tableOfContents)
console.log('TOC length:', page?.tableOfContents?.length)

// Convert headline to HTML (with mint accent support)
const headlineHtml = page.headline ? portableTextToHtml(page.headline, { addHeadingIds: false }) : page.title

// Prepare sections for TOC
const sections = page.showTableOfContents && page.tableOfContents 
  ? page.tableOfContents.map(section => ({
      id: section.id,
      title: section.title
    }))
  : []

// Get SEO metadata
const metaTitle = page.seo?.metaTitle || `${page.title} | AKD Danmark`
const metaDescription = page.seo?.metaDescription || ''
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
>
  <TextPage
    preHeader={page.preHeader}
    headline={headlineHtml}
    sections={sections}
  >
    <PortableText 
      content={page.content} 
      addHeadingIds={true}
    />
    
    {page.updatedAt && (
      <p class="text-sm text-charcoal/70 mt-12">
        Denne side er senest opdateret: {new Date(page.updatedAt).toLocaleDateString('da-DK', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </p>
    )}
  </TextPage>
</BaseLayout>

