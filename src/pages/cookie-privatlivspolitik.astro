---
import BaseLayout from '@/layouts/BaseLayout.astro'
import TextPage from '@/components/templates/TextPage.astro'
import PortableText from '@/components/sanity/PortableText.astro'
import { sanityClient } from '@/lib/sanity'
import { generalPageBySlugQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { GeneralPage } from '@/types/sanity'

export const prerender = true; // Pre-render this page at build time

// Fetch page from Sanity
let page: GeneralPage | null = null
try {
  page = await sanityClient.fetch(generalPageBySlugQuery('cookie-og-privatlivspolitik'))
  console.log('Page fetched from Sanity:', page ? 'Found' : 'Not found')
} catch (error) {
  console.error('Error fetching page from Sanity:', error)
}

if (!page) {
  console.error('Page not found in Sanity with slug: cookie-og-privatlivspolitik')
  return Astro.redirect('/404')
}

// Convert headline to HTML (with mint accent support)
const headlineHtml = page.headline ? portableTextToHtml(page.headline, { addHeadingIds: false }) : page.title

// Prepare sections for TOC
const sections = page.showTableOfContents && page.tableOfContents 
  ? page.tableOfContents.map(section => ({
      id: section.id,
      title: section.title
    }))
  : []

// Get SEO metadata
const metaTitle = page.seo?.metaTitle || `${page.title} | AKD Danmark`
const metaDescription = page.seo?.metaDescription || ''
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
>
  <TextPage
    preHeader={page.preHeader}
    headline={headlineHtml}
    sections={sections}
  >
    <PortableText 
      content={page.content} 
      addHeadingIds={true}
    />
    
    {page.updatedAt && (
      <p class="text-sm text-charcoal/70 mt-12">
        Denne privatlivspolitik er senest opdateret: {new Date(page.updatedAt).toLocaleDateString('da-DK', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </p>
    )}
  </TextPage>
</BaseLayout>

