---
/**
 * Public News Listing
 * Shows only news articles marked as isPublic.
 * Pre-rendered at build time for performance and SEO.
 */

import BaseLayout from '@/layouts/BaseLayout.astro'
import DateBrick from '@/components/andelshavere/DateBrick.astro'
import { sanityClient } from '@/lib/sanity'
import { publicNewsArticlesQuery } from '@/lib/sanityQueries'
import type { NewsArticle } from '@/types/sanity'

export const prerender = true;

let articles: NewsArticle[] = []
try {
  articles = await sanityClient.fetch<NewsArticle[]>(publicNewsArticlesQuery)
} catch (error) {
  console.error('Error fetching public news articles from Sanity:', error)
}
---

<BaseLayout 
  title="Nyheder | AKD Danmark"
  description="Seneste nyheder fra AKD Danmark – kvalitetsstivelse ejet af 600 dedikerede andelshavere"
  navTheme="dark"
>
  <!-- Hero Section -->
  <section class="bg-forest-green pt-12 md:pt-16 pb-16 section-after-nav">
    <div class="container-custom">
      <p class="text-mint font-bold text-base mb-4 uppercase tracking-wide">Nyt fra AKD</p>
      <h1 class="font-sans font-extrabold text-[43px] md:text-[52px] text-white uppercase leading-tight">
        NYHEDER
      </h1>
      <p class="text-white/80 text-lg mt-4 max-w-2xl">
        Hold dig opdateret med de seneste nyheder fra AKD Danmark.
      </p>
    </div>
  </section>

  <!-- News Listing -->
  <section class="bg-warm-light py-12 md:py-16">
    <div class="container-custom">
      {articles.length > 0 ? (() => {
        let lastYear: number | null = null
        return (
          <div class="grid gap-6 max-w-4xl">
            {articles.map((article) => {
              const dateObj = new Date(article.publishedAt)
              const year = dateObj.getFullYear()
              const showDivider = year !== lastYear
              lastYear = year
              return (
                <>
                  {showDivider && (
                    <div class="text-center" style="padding-top: 3rem; padding-bottom: 3rem;">
                      <h3 class="text-2xl md:text-3xl font-serif font-bold text-forest-green">{year}</h3>
                    </div>
                  )}
                  <a
                    href={`/nyheder/${article.slug}`}
                    class="news-card group bg-light rounded-lg p-6 flex gap-5 hover:shadow-md transition-shadow"
                  >
                    <DateBrick date={article.publishedAt} class="mt-1" />
                    <div class="flex-grow min-w-0">
                      <h2 class="text-xl md:text-[22px] font-semibold text-charcoal leading-snug mb-1 group-hover:text-forest-green transition-colors">
                        {article.title}
                      </h2>
                      {article.excerpt && (
                        <p class="text-sm text-charcoal/70 mb-2 line-clamp-2">
                          {article.excerpt}
                        </p>
                      )}
                      <span class="inline-flex items-center gap-1 text-burnt-orange text-sm font-medium">
                        Læs hele nyheden
                        <span aria-hidden="true">→</span>
                      </span>
                    </div>
                  </a>
                </>
              )
            })}
          </div>
        )
      })() : (
        <p class="text-center text-charcoal/60 italic text-lg">
          Ingen offentlige nyheder at vise.
        </p>
      )}
    </div>
  </section>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
