---
import BaseLayout from '@/layouts/BaseLayout.astro'
import JobCard from '@/components/job/JobCard.astro'
import ContentBox from '@/components/sections/ContentBox.astro'
import { sanityClient } from '@/lib/sanity'
import { jobListingsPageQuery, activeJobListingsQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { JobListingsPage, JobListing } from '@/types/sanity'

export const prerender = true;

const [page, listings] = await Promise.all([
  sanityClient.fetch<JobListingsPage>(jobListingsPageQuery),
  sanityClient.fetch<JobListing[]>(activeJobListingsQuery),
])
if (!page) return Astro.redirect('/404')

const headlineHtml = page.hero?.headline
  ? portableTextToHtml(page.hero.headline, { addHeadingIds: false })
  : ''

const introHtml = page.hero?.introText
  ? portableTextToHtml(page.hero.introText, { addHeadingIds: false })
  : ''

const metaTitle = page.seo?.metaTitle || page.title || 'Ledige Stillinger'
const metaDescription = page.seo?.metaDescription || ''

const preHeadline = page.hero?.preHeadline
const listingsHeadline = page.listingsHeadline

const listingsCtaPrimaryText = page.listingsCtaPrimaryText
const listingsCtaPrimaryUrl = page.listingsCtaPrimaryUrl
const listingsCtaSecondaryText = page.listingsCtaSecondaryText
const listingsCtaSecondaryUrl = page.listingsCtaSecondaryUrl

const contentBox = page.contentBox
const contentBoxItems = contentBox?.items || []

const bottomCtaPrimaryText = page.bottomCtaPrimaryText
const bottomCtaPrimaryUrl = page.bottomCtaPrimaryUrl
const bottomCtaSecondaryText = page.bottomCtaSecondaryText
const bottomCtaSecondaryUrl = page.bottomCtaSecondaryUrl
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
  navTheme="light"
>
  <!-- Hero Section -->
  <section class="relative bg-warm-light pt-12 md:pt-16 lg:pt-20 pb-16 section-after-nav">
    <div class="container-custom">
      {preHeadline && (
        <p class="text-mint font-bold text-base mb-6 uppercase tracking-wide text-center">
          {preHeadline}
        </p>
      )}
      
      {headlineHtml && (
        <h1 class="text-center mb-8 md:mb-12 max-w-4xl mx-auto">
          <span class="block font-sans font-extrabold text-[43px] md:text-[58px] lg:text-[62px] text-charcoal uppercase leading-tight [&_.font-serif]:lowercase [&_.font-serif]:font-medium" set:html={headlineHtml} />
        </h1>
      )}
      
      <!-- Body Text -->
      {introHtml && (
        <div class="max-w-4xl mx-auto text-center [&_p]:text-charcoal [&_p]:text-lg [&_p]:md:text-xl [&_p]:leading-relaxed" set:html={introHtml} />
      )}
    </div>
  </section>

  <!-- Job Listings Section -->
  <section class="relative bg-warm-light pt-24 md:pt-32 lg:pt-20 pb-32 md:pb-48">
    <div class="container-custom">
      <div class="max-w-5xl mx-auto">
        {listingsHeadline && (
          <h2 class="font-serif italic text-4xl md:text-[43px] text-charcoal text-center mb-8 md:mb-12">
            {listingsHeadline}
          </h2>
        )}
        
        <!-- Job Cards -->
        {listings.length > 0 ? (
          <div class="space-y-4 mb-8">
            {listings.map((job) => (
              <JobCard
                title={job.title}
                description={job.description}
                location={job.location}
                href={`/job/stillinger/${job.slug}`}
              />
            ))}
          </div>
        ) : (
          <p class="text-center text-charcoal/70 text-lg mb-8">
            Der er ingen ledige stillinger lige nu. Hold øje med siden eller send en uopfordret ansøgning.
          </p>
        )}
        
        <!-- Listings CTAs -->
        {(listingsCtaSecondaryText || listingsCtaPrimaryText) && (
          <div class="flex flex-col sm:flex-row items-center justify-center gap-6 mt-12">
            {listingsCtaSecondaryText && listingsCtaSecondaryUrl && (
              <a href={listingsCtaSecondaryUrl} class="btn-secondary">
                {listingsCtaSecondaryText}
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                </svg>
              </a>
            )}
            {listingsCtaPrimaryText && listingsCtaPrimaryUrl && (
              <a href={listingsCtaPrimaryUrl} class="btn-primary">
                <span>{listingsCtaPrimaryText}</span>
                <span class="btn-icon-circle">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </span>
              </a>
            )}
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Why Choose AKD Section -->
  {contentBox && (
    <section class="relative bg-forest-green pt-1 pb-16 md:pb-24">
      <ContentBox
        variant={contentBox.variant || 'light'}
        layout={contentBox.layout || 'full-width'}
        preHeader={contentBox.preHeader}
        headline={contentBox.headline}
        imageUrl={contentBox.image || '/images/hvofor-vaelge-akd.png'}
        imageAlt={contentBox.imageAlt || ''}
        pullUp={contentBox.pullUp || 100}
        items={contentBoxItems}
      />
    </section>
  )}

  <!-- Bottom CTA Section -->
  {(bottomCtaSecondaryText || bottomCtaPrimaryText) && (
    <section class="relative bg-forest-green pb-16 md:pb-24">
      <div class="container-custom">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-6">
          {bottomCtaSecondaryText && bottomCtaSecondaryUrl && (
            <a href={bottomCtaSecondaryUrl} class="btn-secondary">
              {bottomCtaSecondaryText}
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </a>
          )}
          {bottomCtaPrimaryText && bottomCtaPrimaryUrl && (
            <a href={bottomCtaPrimaryUrl} class="btn-primary">
              <span>{bottomCtaPrimaryText}</span>
              <span class="btn-icon-circle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                </svg>
              </span>
            </a>
          )}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
