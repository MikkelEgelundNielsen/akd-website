---
import BaseLayout from '@/layouts/BaseLayout.astro'
import ContentBox from '@/components/sections/ContentBox.astro'
import { sanityClient } from '@/lib/sanity'
import { workingAtAkdPageQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { WorkingAtAkdPage } from '@/types/sanity'

export const prerender = true;

const page = await sanityClient.fetch<WorkingAtAkdPage>(workingAtAkdPageQuery)
if (!page) return Astro.redirect('/404')

const headlineHtml = page.hero?.headline
  ? portableTextToHtml(page.hero.headline, { addHeadingIds: false })
  : ''

const introHtml = page.hero?.introText
  ? portableTextToHtml(page.hero.introText, { addHeadingIds: false })
  : ''

const metaTitle = page.seo?.metaTitle || page.title || 'At arbejde hos AKD'
const metaDescription = page.seo?.metaDescription || ''

const preHeadline = page.hero?.preHeadline
const primaryCtaText = page.primaryCtaText
const primaryCtaUrl = page.primaryCtaUrl
const secondaryCtaText = page.secondaryCtaText
const secondaryCtaUrl = page.secondaryCtaUrl

const contentBox = page.contentBox
const contentBoxItems = contentBox?.items || []

const gallery = page.photoGallery
const galleryImages = gallery?.images || []
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
  navTheme="light"
>
  <!-- Hero Section -->
  <section class="relative bg-warm-light pt-12 md:pt-16 lg:pt-20 pb-16 pb-28 md:pb-48 section-after-nav">
    <div class="container-custom">
      <!-- Pre-headline -->
      {preHeadline && (
        <p class="text-mint font-bold text-base mb-6 uppercase tracking-wide text-center">
          {preHeadline}
        </p>
      )}
      
      <!-- Main Headline -->
      {headlineHtml && (
        <h1 class="text-center mb-8 md:mb-12 max-w-4xl mx-auto">
          <span class="block font-sans font-extrabold text-[43px] md:text-[58px] lg:text-[62px] text-charcoal uppercase leading-tight [&_.font-serif]:lowercase [&_.font-serif]:font-medium" set:html={headlineHtml} />
        </h1>
      )}
      
      <!-- Body Text -->
      {introHtml && (
        <div class="max-w-4xl mx-auto text-center space-y-6 [&_p]:text-charcoal [&_p]:text-lg [&_p]:md:text-xl [&_p]:leading-relaxed" set:html={introHtml} />
      )}
    </div>
  </section>

  <!-- Content Box Section -->
  {contentBox && (
    <section class="relative bg-forest-green pt-1 pb-16 md:pb-24">
      <ContentBox
        variant={contentBox.variant || 'light'}
        preHeader={contentBox.preHeader}
        headline={contentBox.headline}
        imageUrl={contentBox.image || '/images/at-arbejde-hos-akd/Medarbejdere-44.jpg'}
        imageAlt={contentBox.imageAlt || ''}
        pullUp={contentBox.pullUp || 100}
        items={contentBoxItems}
      />
    </section>
  )}

  <!-- Photo Grid Section -->
  {galleryImages.length > 0 && (
    <section class="relative bg-forest-green py-16 md:py-24">
      <div class="container-custom">
        {gallery?.title && (
          <h2 class="text-white text-center text-4xl md:text-[43px] font-serif font-bold italic mb-12">
            {gallery.title}
          </h2>
        )}
        
        <div class="photo-grid" id="photo-grid">
          {galleryImages.map((img) => (
            <div class="photo-grid-item">
              <img src={img.url} alt={img.alt || 'Hverdagsbillede fra AKD'} loading="lazy" />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="relative bg-forest-green pb-16 md:pb-24">
    <div class="container-custom">
      <div class="flex flex-col sm:flex-row items-center justify-center gap-6">
        <!-- Secondary CTA -->
        <a href={secondaryCtaUrl} class="btn-secondary">
          {secondaryCtaText}
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
        
        <!-- Primary CTA -->
        <a href={primaryCtaUrl} class="btn-primary">
          <span>{primaryCtaText}</span>
          <span class="btn-icon-circle">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .photo-grid {
    position: relative;
    width: 100%;
  }
  
  .photo-grid-item {
    position: absolute;
    width: calc(100% / 1 - 1.5rem);
    margin-bottom: 1.5rem;
    overflow: hidden;
    border-radius: 0.5rem;
    transition: opacity 0.5s ease;
    opacity: 0;
  }
  
  .photo-grid-item.loaded {
    opacity: 1;
  }
  
  .photo-grid-item img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }
  
  @media (min-width: 640px) {
    .photo-grid-item {
      width: calc(100% / 2 - 1rem);
    }
  }
  
  @media (min-width: 1024px) {
    .photo-grid-item {
      width: calc(100% / 3 - 1.33rem);
    }
  }
</style>

<script>
  function initMasonry() {
    const grid = document.getElementById('photo-grid');
    if (!grid) return;
    
    const items = Array.from(grid.querySelectorAll('.photo-grid-item'));
    if (items.length === 0) return;
    
    function getColumnCount() {
      if (window.innerWidth >= 1024) return 3;
      if (window.innerWidth >= 640) return 2;
      return 1;
    }
    
    function getGap() {
      if (window.innerWidth >= 1024) return 20;
      if (window.innerWidth >= 640) return 16;
      return 24;
    }
    
    function layoutMasonry() {
      const columnCount = getColumnCount();
      const gap = getGap();
      const containerWidth = grid.offsetWidth;
      const columnWidth = (containerWidth - (gap * (columnCount - 1))) / columnCount;
      const columnHeights = new Array(columnCount).fill(0);
      
      items.forEach((item) => {
        item.style.width = `${columnWidth}px`;
        item.style.position = 'absolute';
        item.style.visibility = 'hidden';
        item.style.top = '0';
        item.style.left = '0';
        void item.offsetHeight;
        
        const itemHeight = item.offsetHeight || 300;
        const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
        const left = shortestColumnIndex * (columnWidth + gap);
        const top = columnHeights[shortestColumnIndex];
        
        item.style.left = `${left}px`;
        item.style.top = `${top}px`;
        item.style.visibility = 'visible';
        columnHeights[shortestColumnIndex] += itemHeight + gap;
      });
      
      grid.style.height = `${Math.max(...columnHeights)}px`;
    }
    
    const images = items.map(item => item.querySelector('img')).filter(Boolean);
    let loadedCount = 0;
    
    const checkAndLayout = () => {
      loadedCount++;
      if (loadedCount === images.length) {
        grid.offsetHeight;
        requestAnimationFrame(() => {
          layoutMasonry();
          items.forEach(item => item.classList.add('loaded'));
        });
      }
    };
    
    if (images.length === 0) {
      layoutMasonry();
      items.forEach(item => item.classList.add('loaded'));
    } else {
      images.forEach(img => {
        if (img.complete && img.naturalHeight > 0) {
          checkAndLayout();
        } else {
          img.addEventListener('load', checkAndLayout, { once: true });
          img.addEventListener('error', checkAndLayout, { once: true });
        }
      });
    }
    
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => layoutMasonry(), 250);
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonry);
  } else {
    initMasonry();
  }
</script>
