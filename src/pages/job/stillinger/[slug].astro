---
import BaseLayout from '@/layouts/BaseLayout.astro'
import EmployeeStoryBox from '@/components/job/EmployeeStoryBox.astro'
import { sanityClient } from '@/lib/sanity'
import { activeJobListingsQuery, jobListingBySlugQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { JobListing } from '@/types/sanity'

export const prerender = true;

export async function getStaticPaths() {
  const listings = await sanityClient.fetch<JobListing[]>(activeJobListingsQuery)
  
  return listings.map((listing) => ({
    params: { slug: listing.slug },
    props: { listing },
  }))
}

// Get listing from static props or fetch for SSR fallback
let { listing } = Astro.props as { listing: JobListing }

if (!listing?.body) {
  // In getStaticPaths we only get the list-level fields — fetch the full document
  const slug = Astro.params.slug || listing?.slug
  if (slug) {
    listing = await sanityClient.fetch<JobListing>(jobListingBySlugQuery(slug))
  }
}

if (!listing) {
  return Astro.redirect('/job/stillinger')
}

// Department label map
const departmentLabels: Record<string, string> = {
  produktion: 'Produktion',
  vedligehold: 'Vedligehold',
  'pakkeri-lager': 'Pakkeri & lager',
  'administration-service': 'Administration & service',
  'kvalitet-miljoe': 'Kvalitet & miljø',
  'akd-agro': 'AKD Agro',
}

// Render body to HTML
const bodyHtml = listing.body
  ? portableTextToHtml(listing.body, { addHeadingIds: false })
  : ''

// SEO
const metaTitle = listing.seo?.metaTitle || `${listing.title} – ${listing.location} | AKD Danmark`
const metaDescription = listing.seo?.metaDescription || listing.description

// Employees
const employees = listing.employees || []
---

<BaseLayout
  title={metaTitle}
  description={metaDescription}
  navTheme="light"
>
  <!-- Breadcrumb -->
  <section class="relative bg-warm-light pt-12 md:pt-16 lg:pt-20 pb-4 section-after-nav">
    <div class="container-custom">
      <nav aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm text-charcoal/60">
          <li><a href="/job/stillinger" class="hover:text-charcoal transition-colors">Ledige stillinger</a></li>
          <li class="text-charcoal/40">/</li>
          <li class="text-charcoal font-medium">{listing.title}</li>
        </ol>
      </nav>
    </div>
  </section>

  <!-- Job Content Card -->
  <section class="relative bg-warm-light pb-16 md:pb-24">
    <div class="container-custom">
      <div class="bg-white rounded-2xl shadow-md overflow-hidden">
        <!-- Header -->
        <div class="p-8 md:px-12 md:pt-12 lg:px-16 lg:pt-16 pb-8">
          <!-- Title -->
          <h1 class="font-sans font-extrabold text-[36px] md:text-[48px] lg:text-[56px] text-charcoal leading-tight mb-6">
            {listing.title}
          </h1>

          <!-- Short description -->
          <p class="text-charcoal/80 text-xl md:text-2xl leading-relaxed mb-8">
            {listing.description}
          </p>

          <!-- Badges -->
          <div class="flex flex-wrap gap-3 mb-8">
            <span class="inline-flex items-center gap-2 bg-warm-light px-4 py-2 rounded-full text-sm font-semibold text-charcoal">
              <svg class="w-4 h-4 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              {listing.location}
            </span>
            {listing.department && (
              <span class="inline-flex items-center gap-2 bg-warm-light px-4 py-2 rounded-full text-sm font-semibold text-charcoal">
                <svg class="w-4 h-4 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                {departmentLabels[listing.department] || listing.department}
              </span>
            )}
            {listing.externalPartner && (
              <span class="inline-flex items-center gap-2 bg-warm-light px-4 py-2 rounded-full text-sm font-semibold text-charcoal">
                <svg class="w-4 h-4 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Via {listing.externalPartner}
              </span>
            )}
          </div>

        </div>

        <!-- Details Bar with CTA -->
        <div class="border-t border-charcoal/10 px-8 md:px-12 lg:px-16 py-6">
          <div class="flex flex-wrap items-center gap-x-12 gap-y-4 text-sm">
            {listing.applicationDeadline && (
              <div>
                <span class="text-charcoal/50 font-medium block mb-1">Ansøgningsfrist</span>
                <span class="text-charcoal font-semibold">{listing.applicationDeadline}</span>
              </div>
            )}
            {listing.contactName && (
              <div>
                <span class="text-charcoal/50 font-medium block mb-1">Kontakt</span>
                <span class="text-charcoal font-semibold">{listing.contactName}</span>
                {listing.contactPhone && (
                  <a href={`tel:${listing.contactPhone.replace(/\s/g, '')}`} class="text-mint hover:underline ml-2">
                    {listing.contactPhone}
                  </a>
                )}
                {listing.contactEmail && (
                  <a href={`mailto:${listing.contactEmail}`} class="text-mint hover:underline ml-2">
                    {listing.contactEmail}
                  </a>
                )}
              </div>
            )}
            {listing.location && (
              <div>
                <span class="text-charcoal/50 font-medium block mb-1">Arbejdssted</span>
                <span class="text-charcoal font-semibold">AKD {listing.location}</span>
              </div>
            )}
            {listing.applicationUrl && (
              <div class="ml-auto">
                <a href={listing.applicationUrl} target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex">
                  <span>Søg stillingen</span>
                  <span class="btn-icon-circle">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                  </span>
                </a>
              </div>
            )}
          </div>
        </div>

        <!-- Body Content -->
        {bodyHtml && (
          <div class="border-t border-charcoal/10 px-8 md:px-12 lg:px-16 py-12 md:py-16">
            <div class="max-w-3xl prose-akd [&_h2]:font-sans [&_h2]:font-bold [&_h2]:text-2xl [&_h2]:md:text-3xl [&_h2]:text-charcoal [&_h2]:mt-10 [&_h2]:mb-4 [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-xl [&_h3]:md:text-2xl [&_h3]:text-charcoal [&_h3]:mt-8 [&_h3]:mb-3 [&_p]:text-charcoal/80 [&_p]:text-lg [&_p]:leading-relaxed [&_p]:mb-4 [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-4 [&_ul_li]:text-charcoal/80 [&_ul_li]:text-lg [&_ul_li]:leading-relaxed [&_ul_li]:mb-2 [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-4 [&_ol_li]:text-charcoal/80 [&_ol_li]:text-lg [&_ol_li]:leading-relaxed [&_ol_li]:mb-2 [&_strong]:text-charcoal [&_a]:text-mint [&_a]:underline [&_a:hover]:text-charcoal" set:html={bodyHtml} />
          </div>
        )}

        <!-- Interesseret i stillingen? (inside card) -->
        <div class="border-t border-charcoal/10 px-8 md:px-12 lg:px-16 py-10 md:py-12 bg-warm-light">
          <h2 class="font-sans font-bold text-2xl md:text-3xl text-charcoal mb-4">
            Interesseret i stillingen?
          </h2>
          <p class="text-charcoal/70 text-lg mb-6">
            {listing.applicationDeadline
              ? `Ansøgningsfrist: ${listing.applicationDeadline}`
              : 'Vi behandler løbende indkomne ansøgninger.'}
          </p>
          {listing.applicationUrl && (
            <a href={listing.applicationUrl} target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex">
              <span>Søg stillingen nu</span>
              <span class="btn-icon-circle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </span>
            </a>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Employee Stories Section -->
  {employees.length > 0 && (
    <section class="bg-warm-light py-16 md:py-24">
      <div class="container-custom">
        <h2 class="text-charcoal text-center text-4xl md:text-[43px] font-serif font-bold italic mb-12">
          Mød nogle af dine kommende kolleger
        </h2>
        
        <div class="space-y-16 md:space-y-24">
          {employees.map((emp, index) => (
            <EmployeeStoryBox
              quote={emp.quote}
              name={emp.name}
              title={emp.jobTitle}
              location={emp.location}
              description={emp.description}
              imageUrl={emp.image}
              imageAlt={emp.imageAlt || `${emp.name}, ${emp.jobTitle} hos AKD`}
              backgroundColor={index % 2 === 0 ? 'forest-green' : 'charcoal'}
              imagePosition={index % 2 === 0 ? 'left' : 'right'}
              startDate={emp.startDate}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Bottom CTA Section -->
  <section class="bg-charcoal py-16 md:py-24">
    <div class="container-custom text-center">
      <h2 class="font-sans font-bold text-2xl md:text-3xl text-white mb-4">
        Interesseret i stillingen som {listing.title.toLowerCase()}?
      </h2>
      <p class="text-white/70 text-lg mb-8">
        {listing.applicationDeadline
          ? `Ansøgningsfrist: ${listing.applicationDeadline}`
          : 'Vi behandler løbende indkomne ansøgninger.'}
      </p>
      {listing.applicationUrl && (
        <a href={listing.applicationUrl} target="_blank" rel="noopener noreferrer" class="btn-primary inline-flex">
          <span>Søg stillingen nu</span>
          <span class="btn-icon-circle">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
          </span>
        </a>
      )}
    </div>
  </section>
</BaseLayout>
