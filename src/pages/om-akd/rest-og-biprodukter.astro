---
import BaseLayout from '@/layouts/BaseLayout.astro'
import { sanityClient } from '@/lib/sanity'
import { restOgBiprodukterPageQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { RestOgBiprodukterPage } from '@/types/sanity'

export const prerender = true;

const page = await sanityClient.fetch<RestOgBiprodukterPage>(restOgBiprodukterPageQuery)
if (!page) return Astro.redirect('/404')

const headlineHtml = page.hero?.headline
  ? portableTextToHtml(page.hero.headline, { addHeadingIds: false })
  : ''
const introHtml = page.hero?.introText
  ? portableTextToHtml(page.hero.introText, { addHeadingIds: false })
  : ''

const metaTitle = page.seo?.metaTitle || page.title || 'Rest- og biprodukter'
const metaDescription = page.seo?.metaDescription || ''

const proto = page.protamylasseSection
const pulp = page.pulpSection
const rest = page.restprodukterSection
const contact = page.contactSection

const quickNavIcons: Record<string, string> = {
  cube: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',
  cylinder: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>',
  document: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
}

function getDocHref(doc: { fileUrl?: string; url?: string }) {
  return doc.fileUrl || doc.url || '#'
}
---

<BaseLayout
  title={metaTitle}
  description={metaDescription}
  navTheme="light"
>
  <!-- Hero Section -->
  {page.hero && (
    <section class="relative bg-warm-light pt-12 md:pt-16 lg:pt-20 pb-16 section-after-nav">
      <div class="container-custom">
        {page.hero.preHeadline && (
          <p class="text-mint font-bold text-base mb-6 uppercase tracking-wide text-center">
            {page.hero.preHeadline}
          </p>
        )}

        {headlineHtml && (
          <h1 class="text-center mb-8 md:mb-12 max-w-4xl mx-auto">
            <span class="block font-sans font-extrabold text-[43px] md:text-[58px] lg:text-[62px] text-charcoal uppercase leading-tight" set:html={headlineHtml} />
          </h1>
        )}

        {introHtml && (
          <div class="max-w-3xl mx-auto text-center text-charcoal text-lg md:text-xl leading-relaxed prose-akd" set:html={introHtml} />
        )}
      </div>
    </section>
  )}

  <!-- Quick Navigation -->
  {page.quickNavCards && page.quickNavCards.length > 0 && (
    <section class="bg-warm-light pb-16 md:pb-24">
      <div class="container-custom">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          {page.quickNavCards.map((card) => (
            <a href={card.anchor} class="bg-white rounded-2xl p-6 shadow-md hover:shadow-lg transition-shadow group text-center">
              <div class="w-12 h-12 bg-mint/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <Fragment set:html={quickNavIcons[card.icon || 'document'] || quickNavIcons.document} />
                </svg>
              </div>
              <h3 class="font-sans font-bold text-charcoal text-lg mb-2 group-hover:text-mint transition-colors">{card.title}</h3>
              {card.description && <p class="text-charcoal/60 text-sm">{card.description}</p>}
            </a>
          ))}
        </div>
      </div>
    </section>
  )}


  <!-- PROTAMYLASSE -->
  {proto && (
    <section id="protamylasse" class="bg-white py-16 md:py-24 scroll-mt-24">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto">
          {proto.preHeader && <p class="text-mint font-bold text-sm mb-4 uppercase tracking-wide">{proto.preHeader}</p>}
          {proto.headline && (
            <h2 class="font-sans font-extrabold text-3xl md:text-4xl lg:text-[43px] text-charcoal leading-tight mb-6">
              {proto.headline}
            </h2>
          )}
          {proto.introText && (
            <p class="text-charcoal/80 text-xl md:text-2xl leading-relaxed mb-12">
              {proto.introText}
            </p>
          )}

          <div class="space-y-12">
            {proto.contentBlocks?.map((block) => (
              <div>
                <h3 class="font-sans font-bold text-xl md:text-2xl text-charcoal mb-4">{block.headline}</h3>
                {block.body.split('\n\n').map((para: string) => (
                  <p class="text-charcoal/80 text-lg leading-relaxed mb-4">{para}</p>
                ))}
              </div>
            ))}

            <!-- Udbringning / Maskinstationer -->
            {proto.maskinstationer && proto.maskinstationer.length > 0 && (
              <div>
                <h3 class="font-sans font-bold text-xl md:text-2xl text-charcoal mb-4">Udbringning</h3>
                <p class="text-charcoal/80 text-lg leading-relaxed mb-4">
                  Udbringningen er lagt ud til nedenstående maskinstationer, som dækker det meste af vores område med avlere. De har alle udbringningsvogne med præcisionsudstyr og har dygtige traktorførere på vognene.
                </p>
                <ul class="space-y-2 mb-6">
                  {proto.maskinstationer.map((station: string) => (
                    <li class="flex items-start gap-3 text-charcoal/80 text-lg">
                      <svg class="w-5 h-5 text-mint flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                      <span>{station}</span>
                    </li>
                  ))}
                </ul>

                {proto.afhentningHeadline && (
                  <h4 class="font-sans font-semibold text-lg text-charcoal mb-2">{proto.afhentningHeadline}</h4>
                )}
                {proto.afhentningText && (
                  <p class="text-charcoal/80 text-lg leading-relaxed">{proto.afhentningText}</p>
                )}
              </div>
            )}

            <!-- Tildelt mængde -->
            {proto.tildeltMaengde && (
              <div>
                <h3 class="font-sans font-bold text-xl md:text-2xl text-charcoal mb-4">{proto.tildeltMaengde.headline}</h3>
                {proto.tildeltMaengde.body.split('\n\n').map((para: string) => (
                  <p class="text-charcoal/80 text-lg leading-relaxed mb-4">{para}</p>
                ))}
              </div>
            )}

            <!-- Pris -->
            {proto.pris && (
              <div>
                <h3 class="font-sans font-bold text-xl md:text-2xl text-charcoal mb-4">{proto.pris.headline}</h3>
                {proto.pris.body.split('\n\n').map((para: string) => (
                  <p class="text-charcoal/80 text-lg leading-relaxed mb-4" set:html={para.replace(/(\d+ kr\. pr\. ton)/g, '<strong class="text-charcoal">$1</strong>')} />
                ))}

                <!-- Tabel 1: Næringsstofindhold -->
                {proto.nutrientTable && (
                  <div class="mb-8 mt-8">
                    <h4 class="font-sans font-semibold text-lg text-charcoal mb-4">{proto.nutrientTable.headline}</h4>
                    <div class="overflow-x-auto rounded-xl border border-charcoal/10">
                      <table class="w-full text-left text-sm">
                        <thead>
                          <tr class="bg-charcoal text-white">
                            <th class="px-4 py-3 font-semibold">Næringsstof</th>
                            <th class="px-4 py-3 font-semibold text-right">Indhold kg/ton</th>
                            <th class="px-4 py-3 font-semibold text-right">Pris/kg</th>
                            <th class="px-4 py-3 font-semibold text-right">100 % udnyttelse</th>
                            <th class="px-4 py-3 font-semibold text-right">Korrigeret*</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="bg-warm-light/60">
                            <td class="px-4 py-2.5 font-medium text-charcoal/60" colspan="2">Tørstof (TS): 27–30 %</td>
                            <td></td><td></td><td></td>
                          </tr>
                          {proto.nutrientTable.rows.map((row, i: number) => (
                            <tr class={i % 2 === 0 ? 'bg-white' : 'bg-warm-light/30'}>
                              <td class="px-4 py-2.5 font-medium text-charcoal">{row.name}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.content}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.price}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.total100}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.totalAdj}</td>
                            </tr>
                          ))}
                          <tr class="bg-charcoal/5 border-t-2 border-charcoal/20">
                            <td class="px-4 py-3 font-bold text-charcoal">I alt</td>
                            <td></td><td></td>
                            <td class="px-4 py-3 text-right font-bold text-charcoal">{proto.nutrientTable.totalRaw}</td>
                            <td class="px-4 py-3 text-right font-bold text-charcoal">{proto.nutrientTable.totalAdj}</td>
                          </tr>
                          <tr class="bg-mint/10 border-t border-charcoal/10">
                            <td class="px-4 py-3 font-bold text-charcoal" colspan="4">Avlerbetaling, ca. 50 %</td>
                            <td class="px-4 py-3 text-right font-bold text-mint text-base">{proto.nutrientTable.avlerPrice}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    {proto.nutrientTable.footnote && (
                      <p class="text-charcoal/50 text-sm mt-2">{proto.nutrientTable.footnote}</p>
                    )}
                  </div>
                )}

                <!-- Tabel 2: Fragtudligning -->
                {proto.freightTable && (
                  <div>
                    <h4 class="font-sans font-semibold text-lg text-charcoal mb-4">{proto.freightTable.headline}</h4>
                    <div class="overflow-x-auto rounded-xl border border-charcoal/10">
                      <table class="w-full text-left text-sm">
                        <thead>
                          <tr class="bg-charcoal text-white">
                            <th class="px-4 py-3 font-semibold"></th>
                            <th class="px-4 py-3 font-semibold text-right">v/10 km</th>
                            <th class="px-4 py-3 font-semibold text-right">v/40 km</th>
                            <th class="px-4 py-3 font-semibold text-right">v/80 km</th>
                            <th class="px-4 py-3 font-semibold text-right">v/120 km</th>
                          </tr>
                        </thead>
                        <tbody>
                          {proto.freightTable.rows.map((row, i: number) => (
                            <tr class={i % 2 === 0 ? 'bg-white' : 'bg-warm-light/30'}>
                              <td class="px-4 py-2.5 font-medium text-charcoal">{row.label}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.v10}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.v40}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.v80}</td>
                              <td class="px-4 py-2.5 text-right text-charcoal/80">{row.v120}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            )}

            <!-- Deklarationer -->
            {proto.deklarationer && proto.deklarationer.documents?.length > 0 && (
              <div class="bg-warm-light rounded-2xl p-6 md:p-8">
                <h4 class="font-sans font-bold text-lg text-charcoal mb-4">{proto.deklarationer.headline}</h4>
                <div class="space-y-3">
                  {proto.deklarationer.documents.map((doc) => (
                    <a href={getDocHref(doc)} class="flex items-center gap-3 text-charcoal hover:text-mint transition-colors group">
                      <svg class="w-5 h-5 text-mint flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                      <span class="text-lg group-hover:underline">{doc.label}</span>
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  )}


  <!-- PULP -->
  {pulp && (
    <section id="pulp" class="bg-warm-light py-16 md:py-24 scroll-mt-24">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto">
          {pulp.preHeader && <p class="text-mint font-bold text-sm mb-4 uppercase tracking-wide">{pulp.preHeader}</p>}
          {pulp.headline && (
            <h2 class="font-sans font-extrabold text-3xl md:text-4xl lg:text-[43px] text-charcoal leading-tight mb-6">
              {pulp.headline}
            </h2>
          )}
          {pulp.introText && (
            <p class="text-charcoal/80 text-xl md:text-2xl leading-relaxed mb-8">
              {pulp.introText}
            </p>
          )}
          {pulp.bodyText && (
            <p class="text-charcoal/80 text-lg leading-relaxed mb-8" set:html={pulp.bodyText.replace(/(tlf\.\s*\d[\d\s]+)/g, '<a href="tel:+4597180888" class="text-mint hover:underline font-semibold">$1</a>')} />
          )}

          {pulp.documents && pulp.documents.items?.length > 0 && (
            <div class="bg-white rounded-2xl p-6 md:p-8 shadow-md">
              <h4 class="font-sans font-bold text-lg text-charcoal mb-4">{pulp.documents.headline}</h4>
              <div class="space-y-3">
                {pulp.documents.items.map((doc) => (
                  <a href={getDocHref(doc)} class="flex items-center gap-3 text-charcoal hover:text-mint transition-colors group">
                    <svg class="w-5 h-5 text-mint flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-lg group-hover:underline">{doc.label}</span>
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )}


  <!-- RESTPRODUKTER -->
  {rest && (
    <section id="restprodukter" class="bg-white py-16 md:py-24 scroll-mt-24">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto">
          {rest.preHeader && <p class="text-mint font-bold text-sm mb-4 uppercase tracking-wide">{rest.preHeader}</p>}
          {rest.headline && (
            <h2 class="font-sans font-extrabold text-3xl md:text-4xl lg:text-[43px] text-charcoal leading-tight mb-6">
              {rest.headline}
            </h2>
          )}
          {rest.body && rest.body.split('\n\n').map((para: string) => (
            <p class="text-charcoal/80 text-lg leading-relaxed mb-4">{para}</p>
          ))}

          {rest.document && (
            <div class="bg-warm-light rounded-2xl p-6 md:p-8 mb-8">
              <a href={getDocHref(rest.document)} class="flex items-center gap-3 text-charcoal hover:text-mint transition-colors group">
                <svg class="w-5 h-5 text-mint flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="text-lg font-semibold group-hover:underline">{rest.document.label}</span>
              </a>
            </div>
          )}

          {rest.externalLinkText && rest.externalLinkHref && (
            <p class="text-charcoal/80 text-lg leading-relaxed">
              Se også <a href={rest.externalLinkHref} target="_blank" rel="noopener noreferrer" class="text-mint hover:underline font-semibold">{rest.externalLinkText}</a>.
            </p>
          )}
        </div>
      </div>
    </section>
  )}


  <!-- CONTACT SECTION -->
  {contact && (
    <section class="bg-charcoal py-16 md:py-24">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center mb-12">
          {contact.headline && (
            <h2 class="font-sans font-bold text-2xl md:text-3xl text-white mb-4">
              {contact.headline}
            </h2>
          )}
          {contact.description && (
            <p class="text-white/70 text-lg">
              {contact.description}
            </p>
          )}
        </div>

        {contact.contacts && contact.contacts.length > 0 && (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
            {contact.contacts.map((person) => (
              <div class="bg-white/10 rounded-2xl p-6 md:p-8 text-center">
                <div class="w-16 h-16 bg-mint/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                </div>
                <h3 class="text-white font-bold text-lg mb-1">{person.name}</h3>
                {person.role && <p class="text-white/60 text-sm mb-4">{person.role}</p>}
                <div class="space-y-2">
                  {person.phone && (
                    <a href={`tel:+45${person.phone.replace(/\s/g, '')}`} class="block text-mint hover:underline font-semibold">{person.phone}</a>
                  )}
                  {person.email && (
                    <a href={`mailto:${person.email}`} class="block text-mint hover:underline text-sm">{person.email}</a>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </section>
  )}
</BaseLayout>
