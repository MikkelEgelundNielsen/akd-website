---
import BaseLayout from '@/layouts/BaseLayout.astro'
import IconLink from '@/components/ui/IconLink.astro'
import ProcessSteps from '@/components/sections/ProcessSteps.astro'
import FAQAccordion from '@/components/sections/FAQAccordion.astro'
import { sanityClient } from '@/lib/sanity'
import { blivAndelshaverPageQuery } from '@/lib/sanityQueries'
import { portableTextToHtml } from '@/lib/portableTextSerializer'
import type { BlivAndelshaverPage } from '@/types/sanity'

export const prerender = true;

let page: BlivAndelshaverPage | null = null
try {
  page = await sanityClient.fetch<BlivAndelshaverPage>(blivAndelshaverPageQuery)
} catch (error) {
  console.error('Error fetching Bliv Andelshaver page from Sanity:', error)
}

if (!page) {
  return Astro.redirect('/404')
}

const heroHeadlineHtml = page.hero?.headline
  ? portableTextToHtml(page.hero.headline, { addHeadingIds: false })
  : ''
const heroIntroHtml = page.hero?.introText
  ? portableTextToHtml(page.hero.introText, { addHeadingIds: false })
  : ''

const contact = page.contactPerson
const contactSection = page.contactSection
const benefits = page.benefitsSection
const process = page.processSection
const growerLife = page.growerLifeSection
const photoGrid = page.photoGridSection
const testimonials = page.testimonialsSection
const app = page.appSection
const faq = page.faqSection
const cta = page.ctaSection

const benefitsHeadlineHtml = benefits?.headline
  ? portableTextToHtml(benefits.headline, { addHeadingIds: false })
  : ''
const processHeadlineHtml = process?.headline
  ? portableTextToHtml(process.headline, { addHeadingIds: false })
  : ''
const growerLifeHeadlineHtml = growerLife?.headline
  ? portableTextToHtml(growerLife.headline, { addHeadingIds: false })
  : ''
const testimonialsHeadlineHtml = testimonials?.headline
  ? portableTextToHtml(testimonials.headline, { addHeadingIds: false })
  : ''
const appHeadlineHtml = app?.headline
  ? portableTextToHtml(app.headline, { addHeadingIds: false })
  : ''
const ctaHeadlineHtml = cta?.headline
  ? portableTextToHtml(cta.headline, { addHeadingIds: false })
  : ''

const metaTitle = page.seo?.metaTitle || page.title || 'Bliv andelshaver'
const metaDescription = page.seo?.metaDescription || ''
---

<BaseLayout
  title={metaTitle}
  description={metaDescription}
  navTheme="light"
>
  <!-- SECTION 1: Hero -->
  <section class="relative bg-warm-light pt-12 md:pt-16 lg:pt-20 pb-28 md:pb-48 section-after-nav">
    <div class="container-custom">
      {page.hero?.preHeadline && (
        <p class="text-mint font-bold text-lg mb-6 uppercase tracking-wide text-center">
          {page.hero.preHeadline}
        </p>
      )}

      {heroHeadlineHtml && (
        <h1 class="text-center mb-8 md:mb-12 max-w-5xl mx-auto">
          <span class="block font-sans font-extrabold text-[43px] md:text-[58px] lg:text-[58px] text-charcoal uppercase leading-tight" set:html={heroHeadlineHtml} />
        </h1>
      )}

      {heroIntroHtml && (
        <div class="max-w-3xl mx-auto text-center space-y-6 text-charcoal text-lg md:text-xl leading-relaxed prose-akd" set:html={heroIntroHtml} />
      )}
    </div>
  </section>

  <!-- SECTION: Contact (Overlapping) -->
  {contact && contactSection && (
    <section class="relative bg-forest-green pt-1 pb-16 md:pb-24">
      <div class="container-custom -mt-20 sm:-mt-24 md:-mt-28 lg:-mt-[100px]">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden relative z-10">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
            <div class="relative aspect-square lg:aspect-auto min-h-[300px] lg:min-h-[400px]">
              <img
                src={contact.imageUrl || '/images/bjarne.jpg'}
                alt={contact.imageAlt || ''}
                class="absolute inset-0 w-full h-full object-cover bg-warm-light"
              />
            </div>

            <div class="p-8 md:p-10 lg:p-12 flex flex-col justify-center">
              {contactSection.preHeader && (
                <p class="text-mint font-bold text-sm mb-4 uppercase tracking-wide">
                  {contactSection.preHeader}
                </p>
              )}

              {contactSection.headline && (
                <h2 class="font-sans font-extrabold text-[29px] md:text-4xl text-charcoal mb-6 leading-tight">
                  {contactSection.headline}
                </h2>
              )}

              {contactSection.checkmarkItems && contactSection.checkmarkItems.length > 0 && (
                <div class="space-y-6 mb-8">
                  {contactSection.checkmarkItems.map((item) => (
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex-1">
                        <h3 class="font-sans font-bold text-[22px] md:text-2xl text-charcoal mb-1">
                          {item.title}
                        </h3>
                        {item.description && (
                          <p class="text-charcoal/80 text-base leading-relaxed">
                            {item.description}
                          </p>
                        )}
                      </div>
                      <svg class="w-6 h-6 text-mint flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  ))}
                </div>
              )}

              <div class="flex flex-col sm:flex-row gap-4 sm:gap-6">
                {contact.phoneHref && (
                  <IconLink href={contact.phoneHref} icon="phone">
                    {contact.phoneLabel || 'Ring'}
                  </IconLink>
                )}
                {contact.callbackLabel && (
                  <IconLink href="#" icon="calendar" class="callback-trigger" data-reason={contact.callbackReason || 'Bliv andelshaver'}>
                    {contact.callbackLabel}
                  </IconLink>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: Value Pillars -->
  {benefits && benefits.pillars && benefits.pillars.length > 0 && (
    <section id="fordelevedakd" class="relative bg-forest-green pt-16 md:pt-24 pb-16 md:pb-24 scroll-mt-32">
      <div class="container-custom">
        {benefits.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {benefits.preHeader}
          </p>
        )}
        {benefitsHeadlineHtml && (
          <h2 class="text-center mb-12 md:mb-16 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-white uppercase leading-tight" set:html={benefitsHeadlineHtml} />
          </h2>
        )}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 max-w-4xl mx-auto">
          {benefits.pillars.map((pillar) => (
            <div class="flex gap-4">
              <div class="flex-shrink-0 mt-1">
                <svg class="w-6 h-6 text-mint" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div>
                <h3 class="font-sans font-bold text-2xl text-white mb-2">{pillar.title}</h3>
                {pillar.description && <p class="text-white/90 leading-relaxed">{pillar.description}</p>}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: Process Steps -->
  {process && process.steps && process.steps.length > 0 && (
    <section id="trinfortrin" class="relative bg-warm-light pt-16 md:pt-24 pb-16 md:pb-24 scroll-mt-32">
      <div class="container-custom">
        {process.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {process.preHeader}
          </p>
        )}
        {processHeadlineHtml && (
          <h2 class="text-center mb-12 md:mb-16 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-charcoal uppercase leading-tight" set:html={processHeadlineHtml} />
          </h2>
        )}

        <div class="max-w-2xl mx-auto mb-12">
          <ProcessSteps steps={process.steps} variant="light" />
        </div>

        {process.ctaLinks && process.ctaLinks.length > 0 && (
          <div class="flex flex-col sm:flex-row items-center justify-center gap-6">
            {process.ctaLinks.map((link) => (
              link.opensCallbackModal ? (
                link.variant === 'secondary' ? (
                  <a href="#" class="btn-secondary callback-trigger" data-reason={link.callbackReason || ''}>
                    {link.text}
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                  </a>
                ) : (
                  <a href="#" class="btn-primary callback-trigger" data-reason={link.callbackReason || ''}>
                    <span>{link.text}</span>
                    <span class="btn-icon-circle">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                      </svg>
                    </span>
                  </a>
                )
              ) : link.variant === 'secondary' ? (
                <a href={link.href} class="btn-secondary">
                  {link.text}
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </a>
              ) : (
                <a href={link.href} class="btn-primary">
                  <span>{link.text}</span>
                  <span class="btn-icon-circle">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                  </span>
                </a>
              )
            ))}
          </div>
        )}
      </div>
    </section>
  )}

  <!-- SECTION: Grower Life -->
  {growerLife && growerLife.highlights && growerLife.highlights.length > 0 && (
    <section id="livetsomakdavler" class="relative bg-forest-green pt-16 md:pt-24 pb-16 md:pb-24 scroll-mt-32">
      <div class="container-custom">
        {growerLife.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {growerLife.preHeader}
          </p>
        )}
        {growerLifeHeadlineHtml && (
          <h2 class="text-center mb-8 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-white uppercase leading-tight" set:html={growerLifeHeadlineHtml} />
          </h2>
        )}
        {growerLife.description && (
          <p class="text-white/90 text-center text-lg md:text-xl max-w-2xl mx-auto mb-12 md:mb-16">
            {growerLife.description}
          </p>
        )}

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto">
          {growerLife.highlights.map((item) => (
            <div class="flex items-center gap-4 bg-white/10 rounded-lg p-4 md:p-5">
              <div class="w-10 h-10 rounded-full bg-mint/20 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <span class="text-white font-medium">{item.title}</span>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: Photo Grid -->
  {photoGrid && photoGrid.photos && photoGrid.photos.length > 0 && (
    <section class="relative bg-forest-green py-16 md:py-24">
      <div class="container-custom">
        {photoGrid.headline && (
          <h2 class="text-white text-center text-4xl md:text-[43px] font-serif font-bold italic mb-12">
            {photoGrid.headline}
          </h2>
        )}

        <div class="avler-photo-grid" id="avler-photo-grid">
          {photoGrid.photos.map((photo) => (
            <div class="avler-photo-grid-item">
              <img src={photo.url} alt={photo.alt || 'Hverdagsbillede fra AKD-avler'} />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: Testimonials -->
  {testimonials && testimonials.testimonials && testimonials.testimonials.length > 0 && (
    <section class="relative bg-warm-light pt-16 md:pt-24 pb-16 md:pb-24">
      <div class="container-custom">
        {testimonials.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {testimonials.preHeader}
          </p>
        )}
        {testimonialsHeadlineHtml && (
          <h2 class="text-center mb-12 md:mb-16 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-charcoal uppercase leading-tight" set:html={testimonialsHeadlineHtml} />
          </h2>
        )}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
          {testimonials.testimonials.map((t) => (
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
              <svg class="w-8 h-8 text-mint mb-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
              </svg>

              <blockquote class="font-serif italic text-lg md:text-xl text-charcoal leading-relaxed mb-6">
                &ldquo;{t.quote}&rdquo;
              </blockquote>

              <div>
                <p class="font-sans font-semibold text-forest-green">{t.name}</p>
                {(t.title || t.location) && (
                  <p class="text-charcoal/70 text-sm">
                    {[t.title, t.location].filter(Boolean).join(', ')}
                  </p>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: Avlerinfo Selvbetjening -->
  {app && app.features && app.features.length > 0 && (
    <section id="avlerinfoselvbetjening" class="relative bg-forest-green text-white pt-16 md:pt-24 pb-16 md:pb-24">
      <div class="container-custom">
        {app.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {app.preHeader}
          </p>
        )}
        {appHeadlineHtml && (
          <h2 class="text-center mb-8 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-white uppercase leading-tight" set:html={appHeadlineHtml} />
          </h2>
        )}
        {app.description && (
          <div class="max-w-2xl mx-auto text-center mb-12 md:mb-16">
            <p class="text-white/90 text-lg md:text-xl leading-relaxed">
              {app.description}
            </p>
          </div>
        )}

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto mb-12 md:mb-16">
          {app.features.map((feature) => (
            <div class="bg-white/10 rounded-lg p-5 md:p-6">
              <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full bg-mint/20 flex items-center justify-center flex-shrink-0 mt-1">
                  <svg class="w-5 h-5 text-mint" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-white font-bold text-[22px] mb-2 leading-[1.7rem]">{feature.title}</h3>
                  {feature.description && <p class="text-white/80 text-sm leading-relaxed">{feature.description}</p>}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- SECTION: FAQ -->
  {faq && faq.items && faq.items.length > 0 && (
    <section id="faq" class="relative bg-light pt-16 md:pt-24 pb-16 md:pb-24 scroll-mt-32">
      <div class="container-custom">
        {faq.preHeader && (
          <p class="text-mint font-bold text-lg mb-4 uppercase tracking-wide text-center">
            {faq.preHeader}
          </p>
        )}
        {faq.headline && (
          <h2 class="text-center mb-12 md:mb-16 max-w-3xl mx-auto">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-charcoal uppercase leading-tight">
              {faq.headline}
            </span>
          </h2>
        )}

        <div class="max-w-3xl mx-auto mb-12">
          <FAQAccordion items={faq.items.map(i => ({ question: i.question, answer: i.answer }))} variant="light" />
        </div>

        {faq.bottomLinkHref && faq.bottomLinkText && (
          <div class="text-center">
            <a href={faq.bottomLinkHref} class="btn-secondary">
              {faq.bottomLinkText}
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </a>
          </div>
        )}
      </div>
    </section>
  )}

  <!-- SECTION: Final CTA -->
  {cta && (
    <section class="relative bg-charcoal pt-16 md:pt-24 pb-16 md:pb-24">
      <div class="container-custom">
        {ctaHeadlineHtml && (
          <h2 class="mb-6 max-w-3xl mx-auto text-center">
            <span class="block font-sans font-extrabold text-4xl md:text-[43px] lg:text-[49px] text-white uppercase leading-tight" set:html={ctaHeadlineHtml} />
          </h2>
        )}

        {cta.description && (
          <p class="text-white/90 text-lg md:text-xl max-w-2xl mx-auto mb-10 md:mb-12 text-center">
            {cta.description}
          </p>
        )}

        {contact && (
          <div class="max-w-3xl mx-auto mb-10">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
              <div class="flex flex-col sm:flex-row">
                <div class="sm:w-1/3 aspect-square relative bg-warm-light">
                  <img
                    src={contact.imageUrl || '/images/bjarne.jpg'}
                    alt={contact.imageAlt || ''}
                    class="w-full h-full object-cover"
                  />
                </div>

                <div class="sm:w-2/3 p-6 md:p-8 flex flex-col justify-center">
                  {cta.contactCardHeadline && (
                    <h3 class="font-sans font-bold text-2xl md:text-[29px] text-charcoal mb-6 leading-tight">
                      {cta.contactCardHeadline}
                    </h3>
                  )}

                  <div class="flex flex-col sm:flex-row gap-4 sm:gap-6">
                    {contact.phoneHref && (
                      <IconLink href={contact.phoneHref} icon="phone">
                        {contact.phoneLabel || 'Ring'}
                      </IconLink>
                    )}
                    {contact.callbackLabel && (
                      <IconLink href="#" icon="calendar" class="callback-trigger" data-reason={contact.callbackReason || 'Bliv andelshaver'}>
                        {contact.callbackLabel}
                      </IconLink>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {cta.ctaLinks && cta.ctaLinks.length > 0 && (
          <div class="flex flex-col sm:flex-row items-center justify-center gap-6">
            {cta.ctaLinks.map((link) => (
              link.opensCallbackModal ? (
                link.variant === 'secondary' ? (
                  <a href="#" class="btn-secondary callback-trigger" data-reason={link.callbackReason || ''}>
                    {link.text}
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                  </a>
                ) : (
                  <a href="#" class="btn-primary callback-trigger" data-reason={link.callbackReason || ''}>
                    <span>{link.text}</span>
                    <span class="btn-icon-circle">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                      </svg>
                    </span>
                  </a>
                )
              ) : link.variant === 'secondary' ? (
                <a href={link.href} class="btn-secondary">
                  {link.text}
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </a>
              ) : (
                <a href={link.href} class="btn-primary">
                  <span>{link.text}</span>
                  <span class="btn-icon-circle">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                  </span>
                </a>
              )
            ))}
          </div>
        )}
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .avler-photo-grid {
    position: relative;
    width: 100%;
  }

  .avler-photo-grid-item {
    position: absolute;
    width: calc(100% / 1 - 1.5rem);
    margin-bottom: 1.5rem;
    overflow: hidden;
    border-radius: 0.5rem;
    transition: opacity 0.5s ease;
    opacity: 0;
  }

  .avler-photo-grid-item.loaded {
    opacity: 1;
  }

  .avler-photo-grid-item img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  @media (min-width: 640px) {
    .avler-photo-grid-item {
      width: calc(100% / 2 - 1rem);
    }
  }

  @media (min-width: 1024px) {
    .avler-photo-grid-item {
      width: calc(100% / 3 - 1.33rem);
    }
  }
</style>

<script>
  function initAvlerMasonry() {
    const grid = document.getElementById('avler-photo-grid');
    if (!grid) return;

    const items = Array.from(grid.querySelectorAll('.avler-photo-grid-item'));
    if (items.length === 0) return;

    function getColumnCount() {
      if (window.innerWidth >= 1024) return 3;
      if (window.innerWidth >= 640) return 2;
      return 1;
    }

    function getGap() {
      if (window.innerWidth >= 1024) return 20;
      if (window.innerWidth >= 640) return 16;
      return 24;
    }

    function layoutMasonry() {
      const columnCount = getColumnCount();
      const gap = getGap();
      const containerWidth = grid.offsetWidth;
      const columnWidth = (containerWidth - (gap * (columnCount - 1))) / columnCount;

      const columnHeights = new Array(columnCount).fill(0);

      items.forEach((item) => {
        item.style.width = `${columnWidth}px`;
        item.style.position = 'absolute';
        item.style.visibility = 'hidden';
        item.style.top = '0';
        item.style.left = '0';

        void item.offsetHeight;

        const itemHeight = item.offsetHeight || 300;
        const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));

        const left = shortestColumnIndex * (columnWidth + gap);
        const top = columnHeights[shortestColumnIndex];

        item.style.left = `${left}px`;
        item.style.top = `${top}px`;
        item.style.visibility = 'visible';

        columnHeights[shortestColumnIndex] += itemHeight + gap;
      });

      const maxHeight = Math.max(...columnHeights);
      grid.style.height = `${maxHeight}px`;
    }

    const images = items.map(item => item.querySelector('img')).filter(Boolean);
    let loadedCount = 0;

    const checkAndLayout = () => {
      loadedCount++;
      if (loadedCount === images.length) {
        grid.offsetHeight;
        requestAnimationFrame(() => {
          layoutMasonry();
          items.forEach(item => item.classList.add('loaded'));
        });
      }
    };

    if (images.length === 0) {
      layoutMasonry();
      items.forEach(item => item.classList.add('loaded'));
    } else {
      images.forEach(img => {
        if (img.complete && img.naturalHeight > 0) {
          checkAndLayout();
        } else {
          img.addEventListener('load', checkAndLayout, { once: true });
          img.addEventListener('error', checkAndLayout, { once: true });
        }
      });
    }

    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        layoutMasonry();
      }, 250);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAvlerMasonry);
  } else {
    initAvlerMasonry();
  }
</script>
